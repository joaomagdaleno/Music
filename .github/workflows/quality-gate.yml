name: Quality Gate

on:
  workflow_call:
    inputs:
      min_coverage:
        description: 'Minimum code coverage percentage'
        required: false
        default: '80'
        type: string

jobs:
  quality:
    name: Quality Gate
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    timeout-minutes: 20
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          cache: true

      - name: Flutter Pub Get
        working-directory: music_tag_editor
        run: flutter pub get

      - name: Run Flutter Analyzer
        working-directory: music_tag_editor
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: Run Tests
        working-directory: music_tag_editor
        run: flutter test --coverage

      - name: Generate HTML coverage report
        working-directory: music_tag_editor
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html

      - name: Upload HTML coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: music_tag_editor/coverage/html
          retention-days: 15

      - name: Upload lcov artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: music_tag_editor/coverage/lcov.info
          retention-days: 1

      - name: Calculate code coverage
        id: coverage
        run: |
          HIT=$(grep "^LH:" music_tag_editor/coverage/lcov.info | awk '{s+=$2} END {print s}' FS=":")
          FOUND=$(grep "^LF:" music_tag_editor/coverage/lcov.info | awk '{s+=$2} END {print s}' FS=":")
          if [ "$FOUND" -eq 0 ]; then
            COVERAGE="0.0"
          else
            COVERAGE=$(echo "scale=2; 100 * $HIT / $FOUND" | bc)
          fi
          echo "percentage=${COVERAGE}" >> $GITHUB_OUTPUT

  update-coverage-data:
    name: Update Coverage Data Branch
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/beta')

    steps:
      - name: Checkout coverage-data branch
        uses: actions/checkout@v4
        with:
          ref: coverage-data
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download lcov artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-lcov
          path: coverage

      - name: Process coverage data
        run: |
          npx lcov-parse coverage/lcov.info > coverage.json.new
          mv coverage.json.new coverage.json

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add coverage.json
          if ! git diff --staged --quiet; then
            git commit -m "docs: Update code coverage report [skip ci]"
            git push
          fi
