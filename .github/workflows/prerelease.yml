name: Pre-release

on:
  workflow_call:

jobs:
  pre-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: artifacts/windows-installer
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/android-apk
      - name: Download Version Artifact
        uses: actions/download-artifact@v4
        with:
          name: version-info
          path: artifacts/version-info
      
      - name: Read version
        id: version
        run: |
          VERSION=$(find artifacts/windows-installer -type f -name "*.exe" | grep -oP 'v\d+\.\d+\.\d+(-[^\s]+)?' | head -n 1 || echo "unknown")
          # If grep -oP fails, try another way or just read it from a file if we had one.
          # For parity with Notes, let's assume we'll create a version.txt in build-and-package.
          VERSION=$(find artifacts -type f -name "version.txt" | head -n 1 | xargs cat || echo "0.0.0-unknown")
          echo "full_version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create Dev Release (Update Existing)
        if: github.ref == 'refs/heads/dev'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev-latest
          name: Development Build (Dev)
          body: |
            Este é o **Snapshot mais recente** da branch `dev`.
            Versão interna: ${{ steps.version.outputs.full_version }}
            Commit: ${{ github.sha }}
          prerelease: true
          generate_release_notes: false
          files: |
            artifacts/windows-installer/*.exe
            artifacts/android-apk/*.apk
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_unmatched_files: true

      - name: Create Beta Release (Update Existing)
        if: github.ref == 'refs/heads/beta'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: beta-latest
          name: Beta Release
          body: |
            Esta é a versão **Beta mais recente** para testes públicos.
            Próxima versão planejada.
            Versão interna: ${{ steps.version.outputs.full_version }}
            Commit: ${{ github.sha }}
          prerelease: true
          generate_release_notes: false
          files: |
            artifacts/windows-installer/*.exe
            artifacts/android-apk/*.apk
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_unmatched_files: true

      - name: Update latest tag
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git tag -f ${{ github.ref_name }}-latest
          git push -f origin ${{ github.ref_name }}-latest
